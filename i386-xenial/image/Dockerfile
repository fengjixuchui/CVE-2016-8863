FROM i386/ubuntu:xenial as base
RUN sed -i -e 's/^# deb-src /deb-src /g' /etc/apt/sources.list
RUN apt-get -y update && \
    apt-get -y install --no-install-recommends \
        build-essential \
        dpkg-dev \
        git \
        libc6-dbg \
        libffi-dev \
        libssl-dev \
        python3 \
        python3-dev \
        python3-pip \
        python3-setuptools \
        tar \
        xterm \
        wget \
        xz-utils && \
    apt-get -y build-dep --no-install-recommends \
        gdb \
        libupnp && \
    apt-get clean && \
    rm -r /var/lib/apt/lists/*

FROM base as gdb
SHELL ["/bin/bash", "-o", "pipefail", "-c"]
WORKDIR /opt
RUN wget -q -O- https://ftp.gnu.org/gnu/gdb/gdb-10.1.tar.xz | tar -xJ && \
    mv gdb-10.1 gdb
WORKDIR /opt/gdb
RUN ./configure --host=i686-linux-gnu --with-python=python3
RUN make -j"$(getconf _NPROCESSORS_ONLN)"
RUN make install DESTDIR="$PWD/dist"

FROM base as pupnp
SHELL ["/bin/bash", "-o", "pipefail", "-c"]
WORKDIR /opt
RUN wget -q -O- https://github.com/pupnp/pupnp/tarball/release-1.6.18 | tar -xz && \
    mv pupnp-pupnp-6cd1f11 pupnp
WORKDIR /opt/pupnp
RUN ./bootstrap
RUN ./configure
RUN make -j"$(getconf _NPROCESSORS_ONLN)"

FROM base
SHELL ["/bin/bash", "-o", "pipefail", "-c"]
RUN python3 -m pip install --upgrade pip
RUN python3 -m pip install --upgrade https://github.com/Gallopsled/pwntools/zipball/9de743810efc
RUN wget -q -O- https://github.com/hugsy/gef/raw/master/scripts/gef.sh | sh
COPY --from=gdb /opt/gdb/dist/ /
COPY --from=pupnp /opt/pupnp/ /opt/pupnp/
